___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Elevar Monitoring Tag Info",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "Add additional metadata to your pixel errors. Part of Elevar Monitoring Suite. Powered by Elevar Monitoring Variables and The Elevar Monitoring Core Tag.",
  "categories": ["UTILITY", "ANALYTICS", "TAG_MANAGEMENT"],
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const log = require('logToConsole');
const addEventCallback = require("addEventCallback");
const createQueue = require("createQueue");

const TAG_INFO = "elevar_gtm_tag_info";
const addInfo = createQueue(TAG_INFO);

addEventCallback(function(containerId, eventData) {
  	const tags = eventData.tags.filter(tag => tag.name);

	tags.forEach(tag => {
    	addInfo({
        	channel: tag.channel,
          	tagName: tag.name,
          	eventId: data.gtmEventId,
          	variables: typeof tag.variables === 'string' ?
          		tag.variables.split(',').map(variable => variable.trim())
          		: undefined
        });
    });
});

// Call data.gtmOnSuccess when the tag is finished.
data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "elevar_gtm_tag_info"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_metadata",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: has basic info
  code: |-
    eventData.tags = [
      {
        name: 'Tag - 3',
        executionTime: 1,
        id: 286,
        status: "success"
      }
    ];

    const mockData = {
      gtmTagId: 2147483645,
      gtmEventId: 13
    };

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertThat(window[TAG_INFO]).hasLength(1);
    assertThat(window[TAG_INFO][0].tagName).isEqualTo("Tag - 3");
    assertThat(window[TAG_INFO][0].eventId).isEqualTo(13);
- name: no Name
  code: |-
    eventData.tags = [
      {
        channel: 'facebook',
        variables: 'var 1, var 2',
        executionTime: 1,
        id: 286,
        status: "success"
      }
    ];

    const mockData = {
      gtmTagId: 2147483645,
      gtmEventId: 13
    };

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertThat(window[TAG_INFO]).hasLength(0);
- name: with Variables
  code: |-
    eventData.tags = [
      {
        name: 'Tag - 1',
        variables: 'var - 1, var - 2',
        executionTime: 1,
        id: 286,
        status: "success"
      }
    ];

    const mockData = {
      gtmTagId: 2147483645,
      gtmEventId: 13
    };

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();

    assertThat(window[TAG_INFO]).hasLength(1);
    assertThat(window[TAG_INFO][0].variables).isEqualTo(['var - 1', 'var - 2']);
- name: with Channel
  code: |-
    eventData.tags = [
      {
        name: 'Tag - 1',
        channel: 'facebook',
        executionTime: 1,
        id: 286,
        status: "success"
      }
    ];

    const mockData = {
      gtmTagId: 2147483645,
      gtmEventId: 13
    };

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();

    assertThat(window[TAG_INFO]).hasLength(1);
    assertThat(window[TAG_INFO][0].channel).isEqualTo('facebook');
- name: multiple tags
  code: |-
    eventData.tags = [
      {
        name: 'Tag - 1',
        executionTime: 1,
        id: 286,
        status: "success"
      },
      {
        name: 'Tag - 2',
        executionTime: 1,
        id: 287,
        status: "success"
      },
      {
        name: 'Tag - 3',
        executionTime: 1,
        id: 288,
        status: "success"
      }
    ];

    const mockData = {
      gtmTagId: 2147483645,
      gtmEventId: 13
    };

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();

    assertThat(window[TAG_INFO]).hasLength(3);
    assertThat(window[TAG_INFO][0].tagName).isEqualTo('Tag - 1');
    assertThat(window[TAG_INFO][0].eventId).isEqualTo(13);
    assertThat(window[TAG_INFO][1].tagName).isEqualTo('Tag - 2');
    assertThat(window[TAG_INFO][1].eventId).isEqualTo(13);
    assertThat(window[TAG_INFO][2].tagName).isEqualTo('Tag - 3');
    assertThat(window[TAG_INFO][2].eventId).isEqualTo(13);
setup: "const log = require('logToConsole');\n\nconst TAG_INFO = \"elevar_gtm_tag_info\"\
  ;\nlet window = {};\nlet eventData = {\n  tags: []\n};\n\nmock(\"addEventCallback\"\
  , callback => {\n  callback('GTM-12345678', eventData);\n});\n\n/*\nCreates an array\
  \ in the window with the key provided and\nreturns a function that pushes items\
  \ to that array.\n*/\nmock('createQueue', (key) => {\n  const pushToArray = (arr)\
  \ => (item) => {\n    arr.push(item);\n  };\n  \n  if (!window[key]) window[key]\
  \ = [];\n  return pushToArray(window[key]);\n});"


___NOTES___

Created on 29/04/2020, 10:50:52


